import 'dart:async';

import 'package:flutter/material.dart';
import 'package:fokad_admin/src/api/auth/auth_api.dart';
import 'package:fokad_admin/src/api/exploitations/agent_role_api.dart';
import 'package:fokad_admin/src/constants/app_theme.dart';
import 'package:fokad_admin/src/models/exploitations/agent_role_model.dart';
import 'package:fokad_admin/src/models/users/user_model.dart';
import 'package:fokad_admin/src/pages/exploitations/projets/components/agent_projet_xlsx.dart';
import 'package:fokad_admin/src/routes/routes.dart';
import 'package:fokad_admin/src/utils/loading.dart';
import 'package:fokad_admin/src/widgets/print_widget.dart';
import 'package:fokad_admin/src/widgets/title_widget.dart';
import 'package:fokad_admin/src/utils/class_implemented.dart';
import 'package:pluto_grid/pluto_grid.dart';

class ListAgentProjet extends StatefulWidget {
  const ListAgentProjet({Key? key, required this.createdRef}) : super(key: key);
  final DateTime createdRef;

  @override
  State<ListAgentProjet> createState() => _ListAgentProjetState();
}

class _ListAgentProjetState extends State<ListAgentProjet> {
  List<PlutoColumn> columns = [];
  List<PlutoRow> rows = [];
  PlutoGridStateManager? stateManager;
  PlutoGridSelectingMode gridSelectingMode = PlutoGridSelectingMode.row;
  int? id;

  final _formKey = GlobalKey<FormState>();

  TextEditingController agentController = TextEditingController();
  TextEditingController roleController = TextEditingController();

  @override
  void initState() {
    getData();
    agentsColumn();
    agentsRow();
    super.initState();
  }

  @override
  void dispose() {
    agentController.dispose();
    roleController.dispose();
    super.dispose();
  }

  List<AgentRoleModel> dataList = [];
  String? signature;
  Future<void> getData() async {
    UserModel userModel = await AuthApi().getUserId();
    List<AgentRoleModel> agentRoles = await AgentRoleApi().getAllData();
    setState(() {
      signature = userModel.matricule;

      dataList = agentRoles
          .where((element) =>
              element.reference.microsecondsSinceEpoch ==
              widget.createdRef.microsecondsSinceEpoch)
          .toList();
    });
  }

  @override
  Widget build(BuildContext context) {
    return PlutoGrid(
      columns: columns,
      rows: rows,
      onLoaded: (PlutoGridOnLoadedEvent event) {
        stateManager = event.stateManager;
        stateManager!.setShowColumnFilter(true);
        stateManager!.notifyListeners();
      },
      onRowDoubleTap: (PlutoGridOnRowDoubleTapEvent tapEvent) {
        final dataId = tapEvent.row!.cells.values;
        final idPlutoRow = dataId.elementAt(4);
        alertDialog(idPlutoRow.value);
      },
      createHeader: (PlutoGridStateManager header) {
        return Row(
          mainAxisAlignment: MainAxisAlignment.spaceBetween,
          children: [
            const TitleWidget(title: "Liste agents & rôle"),
            Row(
              children: [
                IconButton(
                    onPressed: () {
                      Navigator.pushNamed(
                          context, ExploitationRoutes.expProjet);
                    },
                    icon: Icon(Icons.refresh, color: Colors.green.shade700)),
                PrintWidget(onPressed: () {
                  AgentRoleXlsx().exportToExcel(dataList);
                  if (!mounted) return;
                  ScaffoldMessenger.of(context).showSnackBar(SnackBar(
                    content: const Text("Exportation effectué!"),
                    backgroundColor: Colors.green[700],
                  ));
                })
              ],
            ),
          ],
        );
      },
      configuration: PlutoGridConfiguration(
        columnFilterConfig: PlutoGridColumnFilterConfig(
          filters: const [
            ...FilterHelper.defaultFilters,
            // custom filter
            ClassFilterImplemented(),
          ],
          resolveDefaultColumnFilter: (column, resolver) {
            if (column.field == 'agent') {
              return resolver<ClassFilterImplemented>() as PlutoFilterType;
            } else if (column.field == 'role') {
              return resolver<ClassFilterImplemented>() as PlutoFilterType;
            }
            return resolver<PlutoFilterTypeContains>() as PlutoFilterType;
          },
        ),
      ),
    );
  }

  void agentsColumn() {
    columns = [
      PlutoColumn(
        readOnly: true,
        title: 'Agent',
        field: 'agent',
        type: PlutoColumnType.text(),
        enableRowDrag: true,
        enableContextMenu: false,
        enableDropToResize: true,
        titleTextAlign: PlutoColumnTextAlign.left,
        width: 200,
        minWidth: 150,
      ),
      PlutoColumn(
        readOnly: true,
        title: 'Rôle',
        field: 'role',
        type: PlutoColumnType.text(),
        enableRowDrag: true,
        enableContextMenu: false,
        enableDropToResize: true,
        titleTextAlign: PlutoColumnTextAlign.left,
        width: 300,
        minWidth: 150,
      ),
    ];
  }

  Future agentsRow() async {
    var agentRoles = await AgentRoleApi().getAllData();

    var data = agentRoles
        .where((element) =>
            element.reference.microsecondsSinceEpoch ==
            widget.createdRef.microsecondsSinceEpoch)
        .toList();

    if (mounted) {
      setState(() {
        for (var item in data) {
          rows.add(PlutoRow(cells: {
            'agent': PlutoCell(value: item.agent),
            'role': PlutoCell(value: item.role),
          }));
        }
        stateManager!.resetCurrentState();
      });
    }
  }

  Future alertDialog(int idPlutoRow) {
    return showDialog(
        context: context,
        barrierDismissible: true,
        builder: (context) {
          return StatefulBuilder(builder: (context, StateSetter setState) {
            return AlertDialog(
              title: const Text('Detail Agent'),
              content: SizedBox(
                  height: 200,
                  width: 300,
                  child: FutureBuilder<AgentRoleModel>(
                    future: AgentRoleApi().getOneData(idPlutoRow),
                    builder: (BuildContext context,
                        AsyncSnapshot<AgentRoleModel> snapshot) {
                      if (snapshot.hasData) {
                        AgentRoleModel? data = snapshot.data;
                        return Column(
                          children: [
                            Row(children: [
                              IconButton(
                                  onPressed: () async {
                                    await AgentRoleApi().deleteData(idPlutoRow);
                                  },
                                  icon: const Icon(Icons.delete),
                                  color: Colors.red.shade700)
                            ]),
                            const SizedBox(width: p20),
                            Row(
                              children: [
                                const Expanded(child: Text("Agent")),
                                const SizedBox(width: p20),
                                Expanded(child: Text(data!.agent)),
                              ],
                            ),
                            Row(
                              children: [
                                const Expanded(child: Text("Chargé (role)")),
                                const SizedBox(width: p20),
                                Expanded(child: Text(data.role)),
                              ],
                            ),
                          ],
                        );
                      } else {
                        return Center(child: loading());
                      }
                    },
                  )),
              actions: <Widget>[
                TextButton(
                  onPressed: () => Navigator.pop(context, 'Cancel'),
                  child: const Text('Annuler'),
                ),
                TextButton(
                  onPressed: () {
                    Navigator.pop(context, 'ok');
                  },
                  child: const Text('OK'),
                ),
              ],
            );
          });
        });
  }

  addAgentDialog() {
    return showDialog(
        context: context,
        barrierDismissible: true,
        builder: (context) {
          return StatefulBuilder(builder: (context, StateSetter setState) {
            return AlertDialog(
              title: const Text('Ajout agent'),
              content: SizedBox(
                  height: 200,
                  width: 300,
                  child: Form(
                    key: _formKey,
                    child: Column(
                      children: [
                        agentWidget(),
                        roleWidget(),
                      ],
                    ),
                  )),
              actions: <Widget>[
                TextButton(
                  onPressed: () => Navigator.pop(context, 'Cancel'),
                  child: const Text('Annuler'),
                ),
                TextButton(
                  onPressed: () {
                    final form = _formKey.currentState!;
                    if (form.validate()) {
                      submit();
                      form.reset();
                    }
                  },
                  child: const Text('OK'),
                ),
              ],
            );
          });
        });
  }

  Widget agentWidget() {
    return Container(
        margin: const EdgeInsets.only(bottom: p20),
        child: TextFormField(
          controller: agentController,
          decoration: InputDecoration(
            border:
                OutlineInputBorder(borderRadius: BorderRadius.circular(10.0)),
            labelText: 'Nom de l\'agent',
          ),
          keyboardType: TextInputType.text,
          style: const TextStyle(),
          validator: (value) {
            if (value != null && value.isEmpty) {
              return 'Ce champs est obligatoire';
            } else {
              return null;
            }
          },
        ));
  }

  Widget roleWidget() {
    return Container(
        margin: const EdgeInsets.only(bottom: p20),
        child: TextFormField(
          controller: roleController,
          decoration: InputDecoration(
            border:
                OutlineInputBorder(borderRadius: BorderRadius.circular(10.0)),
            labelText: 'Rôle',
          ),
          keyboardType: TextInputType.text,
          style: const TextStyle(),
          validator: (value) {
            if (value != null && value.isEmpty) {
              return 'Ce champs est obligatoire';
            } else {
              return null;
            }
          },
        ));
  }

  Future<void> submit() async {
    final agentRole = AgentRoleModel(
        reference: widget.createdRef,
        agent: agentController.text,
        role: roleController.text);
    await AgentRoleApi().insertData(agentRole);
    Navigator.pop(context);
    ScaffoldMessenger.of(context).showSnackBar(SnackBar(
      content: const Text("Ajouté avec succès!"),
      backgroundColor: Colors.green[700],
    ));
  }
}
